variables:
  GIT_DEPTH: 5

stages: 
  - test
  - deploy

test:
  image: node:10-alpine
  script:
    - npm ci
    - npm test
  only:
    changes:
      - src/**/*

.deploys:
  image: bozdoz/fabric-deployment
  stage: deploy
  script:
    - fab gitpull dockercomposebuild dockercomposerestart
  after_script:
    - apk add curl
    - |
      curl "https://api.cloudflare.com/client/v4/zones/$CF_ZONE/purge_cache" \
      -H "Authorization: Bearer $CF_TOKEN" \
      -H "Content-Type: application/json" \
      -d "{\"purge_everything\": true}"
  
deploy:
  extends:
    - .deploys
  variables:
    CWD: ~/bozdoz.com/v2
  environment:
    name: production
    url: https://bozdoz.com
  only:
    - master

deploy_staging:
  extends:
    - .deploys
  variables:
    CWD: ~/staging-bozdoz/staging-bozdoz
    CI_DEBUG_TRACE: "true"
  environment:
    name: staging
    url: https://staging.bozdoz.com
  only:
    - staging